# 第三章、数据链路层

### 1、数据链路层使用的信道

数据链路层使用的信道主要有以下两种类型：

- 点对点信道。这种信道使用一对一的点对点通信方式。
- 广播信道。这种信道使用一对多的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发送。 

### 2、数据链路层的简单模型

![数据链路层模型](img/第三章/数据链路层模型.png)

## 3.1  使用点对点信道的数据链路层

### 3.1.1  数据链路和帧  

- 链路 (link) 是一条无源的点到点的物理线路段，中间没有任何其他的交换结点。
  -  一条链路只是一条通路的一个组成部分。
- 数据链路 (data link) 除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。
  - 现在最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。一般的适配器都包括了数据链路层和物理层这两层的功能。   

**物理链路就是上面所说的链路。**

**逻辑链路就是上面的数据链路，是物理链路加上必要的通信协议。**

早期的数据通信协议曾叫做通信规程 (procedure)。因此在数据链路层，规程和协议是同义语。

![](images/QQ截图20200321211855.png)



数据链路层不必考虑物理层如何实现比特传输的细节。甚至还可以更简单地设想好像是沿着两个数据链路层之间的水平方向把帧直接发送到对方。



### 3.1.2  三个基本问题

数据链路层协议有许多种，但有三个基本问题则是共同的。这三个基本问题是：
1. 封装成帧
2. 透明传输
3. 差错控制 

#### 1、封装成帧

封装成帧 (framing) 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。确定帧的界限。
首部和尾部的一个重要作用就是进行帧定界。  

![帧](img/第三章/帧1.png)



![帧2](img/第三章/帧2.png)

**用控制字符进行帧定界的方法举例** 

当数据是由可打印的 ASCII 码组成的文本文件时，帧定界可以使用特殊的帧定界符。

控制字符 SOH (Start Of Header) 放在一帧的最前面，表示帧的首部开始。另一个控制字符 EOT (End Of Transmission) 表示帧的结束。

![界定符](img/第三章/界定符.png)



#### 2、透明传输

如果数据中的某个字节的二进制代码恰好和 SOH 或 EOT 一样，数据链路层就会错误地“找到帧的边界”。

![无转义字符时](img/第三章/无转义字符时.png)

 																				数据部分恰好出现与 EOT 一样的代码

**解决透明传输问题**

解决方法：字节填充 (byte stuffing) 或字符填充 (character stuffing)。

发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入一个<font color='red'>**转义字符**</font>“ESC” (其十六进制编码是 1B)。

接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。

如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符 ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个。 

**用字节填充法解决透明传输的问题** 

![转义字符](img/第三章/转义字符.png)

**透明传输**

![连续比特](img/第三章/连续比特.png)

当数据部分出现了帧界定符字段，则<font color='red'>**每5个连续的比特1后面插入一个比特0**</font>

例如：HDLC协议对0111110001111110组帧后对应的比特串为：

​								 011111<font color='red'>0</font>00011111<font color='red'>0</font>10

#### 3、差错检测

1. 在传输过程中可能会产生比特差错：1 可能会变成 0 而 0 也可能变成 1。
2. 在一段时间内，传输错误的比特占所传输比特总数的比率称为<font color='red'>**误码率 BER**</font> (Bit Error Rate)。
3. 误码率与信噪比有很大的关系。
4. 为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施。 

##### 奇偶校验

![奇偶校验](img/第三章/奇偶校验.png)

举例：信息段位1001110，如果加一位奇偶校验码，若为奇校验，是什么？若为偶校验呢？

​	答：	原信息段位有4个1，为偶数个1						

​				若为奇校验，则应在数据段最后添加一个1，确保整段有5(奇数)个1

​				若为偶校验，则应在数据段最后添加一个0，确保整段有4(偶数)个1

​				奇校验时，当传输过程产生1位误码(“1”变成“0”)，则发现变成偶数个1，检测出错



##### 循环冗余检验

- 在数据链路层传送的帧中，广泛使用了循环冗余检验 CRC 的检错技术。
- 在发送端，先把数据划分为组。假定每组 k 个比特。 
- 假设待传送的一组数据 M = 101001（现在 k = 6）。我们在 M 的后面再添加供差错检测用的 n 位冗余码一起发送。  

###### 冗余码的计算

1. 用二进制的模 2 运算进行 2n 乘 M 的运算，这相当于在 M 后面添加 n 个 0。
2. 得到的 (k + n) 位的数除以事先选定好的长度为 (n + 1) 位的除数 P，得出商是 Q 而余数是 R，余数 R 比除数 P 少 1 位，即 R 是 n 位。 
3. 将余数 R 作为冗余码拼接在数据 M 后面发送出去。

![循环冗余校验例题](img/第三章/循环冗余校验例题.png)



###### 帧检验序列 FCS

- 在数据后面添加上的冗余码称为帧检验序列 FCS (Frame Check Sequence)。
- 循环冗余检验 CRC 和帧检验序列 FCS 并不等同。
  - CRC 是一种常用的检错方法，而 FCS 是添加在数据后面的冗余码。
  - FCS 可以用 CRC 这种方法得出，但 CRC 并非用来获得 FCS 的唯一方法。  

接收端对收到的每一帧进行 CRC 检验 

(1) **<font color='red'>若得出的余数 R = 0，则判定这个帧没有差错，就接受</font>。**

(2) **<font color='red'>若余数 R ≠ 0，则判定这个帧有差错，就丢弃</font>。**

![循环冗余校验检测例题](img/第三章/循环冗余校验检测例题.png)

但这种检测方法并不能确定究竟是哪一个或哪几个比特出现了差错。

只要经过严格的挑选，并使用位数足够多的除数 P，那么出现检测不到的差错的概率就很小很小。 

###### 应当注意

1. 仅用循环冗余检验 CRC 差错检测技术只能做到无差错接受。
2. “无差错接受”是指：“凡是接受的帧（即不包括丢弃的帧），我们都能以非常接近于 1 的概率认为这些帧在传输过程中没有产生差错”。
3. 也就是说：“凡是接收端数据链路层接受的帧都没有传输差错”（有差错的帧就丢弃而不接受）。
4. 要做到“可靠传输”（即发送什么就收到什么）就必须再加上确认和重传机制。  
5. 应当明确，“无比特差错”与“无传输差错”是不同的概念。
6. 在数据链路层使用 CRC 检验，能够实现无比特差错的传输，但这还不是可靠传输。
7. 本章介绍的数据链路层协议都不是可靠传输的协议。



##### 海明码

**步骤**：

确定校验码位数（有多少位）r

![海明码校验位数](img/第三章/海明码校验位数.png)

穷举即可，数据位m=4，带入上述不等式

![海明码插入](img/第三章/海明码插入.png)

校验码1**表示原始数据的那一位的序号转为二进制码后，二进制序号第一位（例如110）为1的数据与该校验码组成一组监督关系式S

举例：若信息位位7位，要构成能纠正一位错的海明码，则至少要加上多少位冗余位？并写出监督关系式

![海明码例题1](img/第三章/海明码例题1.png)

⊕表示异或，0⊕0=0，1⊕0=1，0⊕1=1，1⊕1=0（同为0，异为1）

举例：若信息位为1001000，要构成能纠正一位错的海明码，利用上题监督关系式求其冗余位

![海明码例题2](img/第三章/海明码例题2.png)

![海明码例题3](img/第三章/海明码例题3.png)



## 3.2 可靠传输

![可靠传输](img/第三章/可靠传输.png)

![可靠传输服务](img/第三章/可靠传输服务.png)

### 3.2.1 停止-等待协议

![停止-等待协议](img/第三章/停止-等待协议.png)

<font color='red'>**发送方发送数据后，停止发送数据，等待接受方的ACK后才继续传输下一个数据**</font>

确认与否认：DATA在传输过程中出现误码，接收方丢弃该分组并发送NAK，发送方收到NAK后就知道上次传输的DATA出现误码，因此重传上次数据，等待接收方本次的ACK确认。

超时重传：DATA在传输过程中丢失，发送方在经过一定时间后仍未收到ACK，判断超时，重传数据。

确认丢失：接收方对本次数据的ACK丢失了，发送方在经过一定时间后仍未收到ACK，判断超时，重传数据，接收方发现这是一个重复数据DATA0，丢弃该数据并再次发送该数据的ACK。（为解决本问题，<font color='red'>为所有数据加上一个顺序编号</font>）

确认迟到：接收方发送的ACK的传输时间超过了发送方的超时重传时间，发送方在经过一定时间后仍未收到ACK，判断超时，重传数据，随后接收方发送针对本次重传的数据ACK，稍微一段时间后，发送方收到了DATA0的ACK，发送下一个数据DATA1，再一段时间后，发送方收到了上一份重传的数据的ACK，误以为是对DATA1的确认。（为解决本问题，<font color='red'>为所有ACK加上一个顺序编号</font>）

**信道利用率：**

![停止-等待协议信道利用率](img/第三章/停止-等待协议信道利用率.png)



### 3.2.1 回退N帧协议

![回退N帧协议](img/第三章/回退N帧协议.png)

接收方收到5个数据帧后，发送ACK0~ACK4，也可以只发送ACK4，因为即便其中一个ACK丢失了发送方也知道4号数据前的所有数据都已接收。

![回退N帧差错情况1](img/第三章/回退N帧差错情况1.png)

发送方发送5、6、7、0、1号数据，假设5号数据丢失了，接收方检测到序号不匹配。重复发送4个ACK4(对4号数据确认)。发送方收到连续的4个ACK4后，就知道5号数据丢失了，于是超时重传，重传时间可以具体情况具体决定。

![回退N帧差错情况2](img/第三章/回退N帧差错情况2.png)

由于5号数据未被接受，接收方一并不接受5号以后的数据，称为回退N帧，发送方仍然要重传5号以后的数据

![回退N帧窗口超出](img/第三章/回退N帧窗口超出.png)

发送窗口发送0-7号数据，接收方按序接受，并发送一个ACK7，假设ACK7丢失了，触发发送方超时重传，此时重发0-7数据，但接收方此前已正确接受这份数据，且序号为0，误以为这是新的分组，导致数据重复

![回退N帧窗口上下限](img/第三章/回退N帧窗口上下限.png)



### 3.2.1 选择重传协议

发送方发送0-3号数据，2号数据丢失了，接收方接受0、1、3数据后，发送ACK0、ACK1、ACK3，并等待发送方发送2号数据

![选择重传协议1](img/第三章/选择重传协议1.png)

发送方收到ACK0、ACK1后，向前滑动窗口，将0号和1号从缓存中删除，发送4号和5号，发送后ACK3到达发送方。接受窗口0号和1号交付上层处理

![选择重传协议2](img/第三章/选择重传协议2.png)

发送方接收到ACK3后，知道这是未按序到达的ACK，重发2号数据，发送窗口内3号打上确认标记，接收到ACK4和ACK5后，同样也会打上标记

![选择重传协议3](img/第三章/选择重传协议3.png)

接收方收到2号数据后，发送ACK2，接收窗口向前滑动准备接收数据，发送方接收到2号数据后，发送窗口向前滑动到6号位置

![选择重传协议4](img/第三章/选择重传协议4.png)

发送窗口超出时：

![选择重传窗口超出情况](img/第三章/选择重传窗口超出情况.png)

发送方发送0-4号数据，接收方依次接收并发送ACK0-ACK4，但ACK0丢失了，发送方依次接收ACK，发现ACK0未正确按序接收，超时重传，但接收窗口已经向前滑动且有一个序号0，接收方收到超时重传的0号数据后误以为这是新的数据

![选择重传协议窗口上下限](img/第三章/选择重传协议窗口上下限.png)

## 3.3  点对点协议 PPP

### 3.3.1  PPP 协议的特点

1. 对于点对点的链路，目前使用得最广泛的数据链路层协议是点对点协议 PPP (Point-to-Point Protocol)。
2. 用户使用拨号电话线接入互联网时， 用户计算机和 ISP 进行通信时所使用的数据链路层协议就是 PPP 协议。

**用户到 ISP 的链路使用 PPP 协议** 

![PPP协议](img/第三章/PPP协议.png)

#### 3、PPP 协议的组成

PPP 协议有三个组成部分：

(1) 一个将 IP 数据报封装到串行链路的方法。

(2) 链路控制协议 LCP (Link Control Protocol)。

(3) 网络控制协议 NCP (Network Control Protocol)。   

### 3.3.2  PPP 协议的帧格式

- PPP 帧的首部和尾部分别为 4 个字段和 2 个字段。
- 标志字段 F = 0x7E （符号“0x”表示后面的字符是用十六进制表示。十六进制的 7E 的二进制表示是 01111110）。
- 地址字段 A 只置为 0xFF。地址字段实际上并不起作用。
- 控制字段 C 通常置为 0x03。
- PPP 是面向字节的，所有的 PPP 帧的长度都是整数字节。

**PPP 协议的帧格式**

![PPP帧格式](img/第三章/PPP帧格式.png)

透明传输问题 

1. 当 PPP 用在同步传输链路时，协议规定采用硬件来完成比特填充（和 HDLC 的做法一样）。 
2. 当 PPP 用在异步传输时，就使用一种特殊的字符填充法。 

**字符填充** 

![PPP字符填充法](img/第三章/PPP字符填充法.png)

**零比特填充** 

PPP 协议用在 SONET/SDH 链路时，使用同步传输（一连串的比特连续传送）。这时 PPP 协议采用零比特填充方法来实现透明传输。

![PPP0比特填充法](img/第三章/PPP0比特填充法.png)

 不提供使用序号和确认的可靠传输 

PPP 协议之所以不使用序号和确认机制是出于以下的考虑：

- 在数据链路层出现差错的概率不大时，使用比较简单的 PPP 协议较为合理。
- 在因特网环境下，PPP 的信息字段放入的数据是 IP  数据报。数据链路层的可靠传输并不能够保证网络层的传输也是可靠的。
- 帧检验序列 FCS 字段可保证无差错接受。



### 3.3.3  PPP 协议的工作状态

- 当用户拨号接入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。
- PC 机向路由器发送一系列的 LCP 分组（封装成多个 PPP 帧）。
- 这些分组及其响应选择一些 PPP 参数，并进行网络层配置，NCP 给新接入的 PC 机分配一个临时的 IP 地址，使 PC 机成为因特网上的一个主机。
- 通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层的连接。

![PPP工作状态](img/第三章/PPP工作状态.png)

## 3.4  媒体接入控制

### 3.4.1  局域网的数据链路层

- 局域网最主要的特点是：
  - 网络为一个单位所拥有；
  - 地理范围和站点数目均有限。 

- 局域网具有如下主要优点：
  - 具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源。 
  - 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变。
  - 提高了系统的可靠性、可用性和残存性。

**局域网拓扑结构**

![](images/QQ截图20200321215052.png)



**媒体共享技术**

静态划分信道:

- 频分复用
- 时分复用
- 波分复用
- 码分复用 

动态媒体接入控制（多点接入）:

- 随机接入
- 受控接入 ，如多点线路探询 (polling)，或轮询。  	

#### 1  以太网的两个标准  

- DIX Ethernet V2 是世界上第一个局域网产品（以太网）的规约。
- IEEE 802.3 是第一个 IEEE 的以太网标准。
- DIX Ethernet V2 标准与 IEEE 的 802.3 标准只有很小的差别，因此可以将 802.3 局域网简称为“以太网”。
- 严格说来，“以太网”应当是指符合 DIX Ethernet V2 标准的局域网 。 

**数据链路层的两个子层** 

- 为了使数据链路层能更好地适应多种局域网标准，IEEE 802 委员会就将局域网的数据链路层拆成两个子层：
  - 逻辑链路控制 LLC (Logical Link Control)子层；
  - 媒体接入控制 MAC (Medium Access Control)子层。

- 与接入到传输媒体有关的内容都放在 MAC子层，而 LLC 子层则与传输媒体无关。

- 不管采用何种协议的局域网，对 LLC 子层来说都是透明的。

**局域网对LLC子层是透明的**

![](images/QQ截图20200321215430.png)

**一般不考虑 LLC 子层** 

由于 TCP/IP 体系经常使用的局域网是 DIX Ethernet V2 而不是 802.3 标准中的几种局域网，因此现在 802 委员会制定的逻辑链路控制子层 LLC（即 802.2 标准）的作用已经不大了。

很多厂商生产的适配器上就仅装有 MAC 协议而没有 LLC 协议。 

#### 2.  适配器的作用  

- 网络接口板又称为通信适配器 (adapter) 或网络接口卡 NIC (Network Interface Card)，或“网卡”。 
- 适配器的重要功能：
  - 进行串行/并行转换。
  - 对数据进行缓存。
  - 在计算机的操作系统安装设备驱动程序。
  - 实现以太网协议。  

**计算机通过适配器和局域网进行通信** 

![](images/QQ截图20200321215648.png)



#### 以太网采用广播方式发送

- 总线上的每一个工作的计算机都能检测到 B 发送的数据信号。 
- 由于只有计算机 D 的地址与数据帧首部写入的地址一致，因此只有 D 才接收这个数据帧。 
- 其他所有的计算机（A, C 和 E）都检测到不是发送给它们的数据帧，因此就丢弃这个数据帧而不能够收下来。
- 在具有广播特性的总线上实现了一对一的通信。  

#### **以太网采取了两种重要的措施**

为了通信的简便，以太网采取了两种重要的措施：

采用较为灵活的<font color='red'>**无连接**</font>的工作方式

- 不必先建立连接就可以直接发送数据。
- 对发送的数据帧不进行编号，也不要求对方发回确认。

#### **以太网提供的服务**

- 以太网提供的服务是不可靠的交付，即尽最大努力的交付。
- <font color='red'>**当目的站收到有差错的数据帧时就丢弃此帧，其他什么也不做。**</font>差错的纠正由高层来决定。
- 如果高层发现丢失了一些数据而进行重传，但以太网并不知道这是一个重传的帧，而是当作一个新的数据帧来发送。  

(2) <font color='red'>**以太网发送的数据都使用曼彻斯特编码**</font>

![](images/QQ截图20200321220207.png)



### 3.4.2 ALOHA协议

![ALOHA1](img/第三章/ALOHA1.png)

![ALOHA2](img/第三章/ALOHA2.png)

### 3.4.3 CSMA协议

CS：载波监听，每个站在发送数据前要检测信道上是否有其他站点在发送数据

MA：多点接入，表示许多计算机以多接入的方式链接在一根总线上

|          |  1-坚持CSMA  |            非坚持CSMA            |                p-坚持CSMA                |
| :------: | :----------: | :------------------------------: | :--------------------------------------: |
| 信道空闲 |    马上发    |              马上发              | p概率马上发，1-p概率等到下一个时隙再发送 |
|  信道忙  | 继续坚持监听 | 放弃监听，等待一个随机时间再监听 |   持续监听，直到信道空闲再以p概率发送    |



### 3.4.4  CSMA/CD 协议

#### **CSMA/CD协议** 

- CSMA/CD 含义：载波监听多点接入 / 碰撞检测  (Carrier Sense Multiple Access with Collision Detection) 。

- “多点接入”表示许多计算机以多点接入的方式连接在一根总线上。

- “载波监听”是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞。 

- 总线上并没有什么“载波”。因此， “载波监听”就是用电子技术检测总线上有没有其他计算机发送的数据信号。

	![CSMACD示意](img/第三章/CSMACD示意.png)

##### **碰撞检测**

- “碰撞检测”就是计算机边发送数据边检测信道上的信号电压大小。
- 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。
- 当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。

##### **检测到碰撞后**

- 在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。
- <font color='red'>**每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送**</font>，免得继续浪费网络资源，然后等待一段随机时间后再次发送。

##### **为什么要进行碰撞检测？**

- 由于电磁波在总线上的传播速率是有限的，当某个站监听到总线是空闲时，也可能总线并非真正是空闲的。 
- A 向 B 发出的信息，要经过一定的时间后才能传送到 B。
- B 若在 A 发送的信息到达 B 之前发送自己的帧 (因为这时 B 的载波监听检测不到 A 所发送的信息)，则必然要在某个时间和 A 发送的帧发生碰撞。
- 碰撞的结果是两个帧都变得无用。
- 所以需要在发送期间进行碰撞检测，以检测冲突。  

##### **信号传播时延对载波监听的影响** 

![CSMACD争用期](img/第三章/CSMACD争用期.png)

δ为右边三角形的底，当δ->0时(即右边三角形无限趋近于0)，能确保发送的数据没有发送碰撞

##### **CSMA/CD 重要特性**

- 使用 CSMA/CD 协议的以太网<font color='red'>**不能进行全双工通信而只能进行双向交替通信**</font>（<font color='red'>**半双工通信**</font>）。
- 每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。 
- 这种发送的不确定性使整个以太网的平均通信量远小于以太网的最高数据率。  

##### **争用期**

最先发送数据帧的站，在发送数据帧后至多经过时间 2τ （两倍的端到端往返时延）就可知道发送的数据帧是否遭受了碰撞。

以太网的端到端往返时延 2τ 称为争用期，或碰撞窗口。

经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。

**二进制指数类型退避算法**

![CSMACD退避算法](img/第三章/CSMACD退避算法.png)

##### **争用期的长度** 

对于 10 Mbit/s 以太网，在争用期内可发送 512 bit，即 64 字节。

这意味着：
以太网在发送数据时，<font color='red'>**若前 64 字节没有发生冲突，则后续的数据就不会发生冲突。**</font>

##### **最短帧长** 

![CSMACD最短帧长](img/第三章/CSMACD最短帧长.png)

A向D发送一个较短的帧，短帧发送完毕后不再检测碰撞，帧长在总线上传输，此时C要发送数据，在短帧还没到达C时，C在经过96比特时间认为总线空闲，发送数据，短帧到达C，碰撞，碰撞后的帧到达D，被检测差错，丢弃。

1. 如果发生冲突，就一定是在发送的<font color='red'>前 64 字节之内</font>。 
2. 由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于 64 字节。 
3. <font color='red'>**以太网规定了最短有效帧长为 64 字节**</font>，凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧。

##### **最大帧长**

![CSMACD最大帧长](img/第三章/CSMACD最大帧长.png)

##### 信道利用率

![CSMACD极限信道利用率](img/第三章/CSMACD极限信道利用率.png)

![CSMACD利用率提升](img/第三章/CSMACD利用率提升.png)

##### CSMA/CD协议总结

(1) 准备发送。但在发送之前，必须先检测信道。

(2) 检测信道。若检测到信道忙，则应不停地检测，一直等待信道转为空闲。若检测到信道空闲，并在 96 比特时间内信道保持空闲（保证了帧间最小间隔），就发送这个帧。

(3) 检查碰撞。在发送过程中仍不停地检测信道，即网络适配器要边发送边监听。这里只有两种可能性：

​	①发送成功：在争用期内一直未检测到碰撞。这个帧肯定能够发送成功。发送完毕后，其他什么也不做。然后回到 (1)。

​	②发送失败：在争用期内检测到碰撞。这时立即停止发送数据，并按规定发送人为干扰信号。适配器接着就执行指数退避算法，等待 r 倍 512 比特时间后，返回到步骤 (2)，继续检测信道。但若<font color='red'>**重传达 16 次仍不能成功，则停止重传而向上报错**</font>。

### 3.4.5 CSMA/CA协议

##### 工作原理

![CSMACA协议](img/第三章/CSMACA协议.png)

**DIFS**：考虑到可能有其他站有高优先级的帧要发送，若有，就要让高优先级帧先发送。

**SIFS**：最短的帧间间隔，用来分隔开属于一次对话的各帧，在这段时间内，一个站点应当能够从发送方式切换到接收方式。

**退避一段随机时间**：防止多个站点同时发送数据而产生碰撞。

##### 退避算法

![CSMACA退避算法](img/第三章/CSMACA退避算法.png)

##### CSMA/CA协议的信道预约和虚拟载波

![CSMACA预约机制](img/第三章/CSMACA预约机制.png)

通俗的讲，源站向目的站告知（RTS）其将发送数据（预约），目的站告知（CTS）其他站点不要发送数据，因为信道忙

![CSMACA预约机制举例](img/第三章/CSMACA预约机制举例.png)

A若要向B发送数据，则先发送RTS帧，尽管C的作用范围收不到该RTS帧，但B广播的CTS帧使得其他站点知道信道上有预约，不发送数据

##### CSMA/CA协议总结

CSMA/CA使用停止-等待协议实现可靠传输（会发送确认帧ACK）
所有站完成发送之后会退避一段时间
允许预约

### 四个协议总结

![4个协议总结](img/第三章/4个协议总结.png)

### 3.4.6  以太网的 MAC 层

#### MAC 层的硬件地址

使用局域网时，每个主机发送的帧中必须携带表示发送主机和接收主机的地址，这类地址成为MAC(Media Access Control)地址

- MAC地址一般被固化在网卡（网络适配器）中
- MAC地址也称为物理地址。注意：<font color='red'>**这不说明MAC地址属于网络体系结构的物理层**</font>
- 一般情况下，每个网卡（网络适配器）都有一个全球唯一的MAC地址。而交换机和路由器往往有很多网络接口，所以，严格来说，MAC地址是对网络上<font color='red'>**各接口的唯一标识**</font>，而不是对网络上各设备的唯一标识

#### **48 位的 MAC 地址**

IEEE 802 标准规定 MAC 地址字段可采用 6 字节 ( 48位) 或 2 字节 ( 16 位) 这两种中的一种。

IEEE 的注册管理机构 RA 负责向厂家分配地址字段 6 个字节中的前三个字节 (即高位 24 位)，称为组织唯一标识符。

地址字段 6 个字节中的后三个字节 (即低位 24 位) 由厂家自行指派，称为扩展唯一标识符，必须保证生产出的适配器没有重复地址。

![MAC地址格式](img/第三章/MAC地址格式.png)

#### **单播**

![MAC单播](img/第三章/MAC单播.png)

#### **多播**

![MAC多播](img/第三章/MAC多播.png)

#### **广播**

![MAC广播](img/第三章/MAC广播.png)

#### **适配器检查 MAC 地址**

- 所有的适配器都**至少能够识别前两种帧，即能够识别单播地址和广播地址**。
- 有的适配器可用编程方法识别多播地址。
- **只有目的地址才能使用广播地址和多播地址**。
- 以混杂方式工作的以太网适配器只要“听到”有帧在以太网上传输就都接收下来。

#### IP地址与MAC地址

![MAC地址与IP地址](img/第三章/MAC地址与IP地址.png)

路由器知道目的（H2）IP地址，但不知道目的（H2）MAC地址是什么，要通过IP地址知道MAC地址，应使用ARP协议

![MAC地址与IP地址例题](img/第三章/MAC地址与IP地址例题.png)

### ARP协议

<font color='red'>**该协议为网络层内容**</font>

ARP协议具体表现为：通过目的IP地址知道下一跳的MAC地址，广播自己的IP地址和MAC地址请求

例如，主机B想知道C的MAC地址，则<font color='red'>**广播**</font>自己的IP地址和MAC地址和自己的请求，各主机收到广播后，对照发来的请求IP地址，若不是自己主机的IP地址，不予理会，若是，则处理

![ARP协议](img/第三章/ARP协议.png)

主机C随后<font color='red'>**单播**</font>响应报文

![ARP响应报文](img/第三章/ARP响应报文.png)

主机B更新自己的高速缓存表

![ARP高速缓存表](img/第三章/ARP高速缓存表.png)

动态：自动获取，生命周期默认2分钟

静态：手工设置，不同操作系统下的生命周期不同，例如系统重启后不存在或重启后依然有效

ARP协议<font color='red'>**不能跨网络进行，只能在一段链路上进行**</font>

![ARP协议局限性](img/第三章/ARP协议局限性.png)

## 3.5集线器与交换机

### 3.5.1 集线器

集线器是各主机能相互通信的设备，网络拓补为总线型，采用CSMA/CD协议
换句话说，集线器会向冲突域内所有主机（除源主机外）转发源主机发送的数据

![集线器](img/第三章/集线器.png)

若三个集线器连在另一个集线器，则会造成更大的冲突域

![集线器更大冲突域](img/第三章/集线器更大冲突域.png)

一系的某一主机要发送数据给二系某一主机，主干HUB会向整个网络的其他主机转发该数据

### 3.5.2 交换机

![交换机](img/第三章/交换机.png)

#### 交换机自学习

起初，交换机的表为空，因此当A->B时，交换机会登记A的MAC地址和接口，并进行泛洪转发，交换机2通过接口4收到该转发，查找自己的表，为空，登记A的地址和接口并泛洪转发

![交换机自学习1](img/第三章/交换机自学习1.png)

B->A时，交换机登记B的MAC地址和接口，查找自己的表发现有目的MAC地址A，明确转发，显然交换机2不会收到该转发

![交换机自学习2](img/第三章/交换机自学习2.png)

E->A时，交换机2查表，找到了A的MAC地址与接口2，明确转发到交换机1，交换机1查表，找到了A的MAC地址与接口2，明确转发给主机A

![交换机自学习3](img/第三章/交换机自学习3.png)

<font color='red'>**表中的所有记录都有自己的有效时间，到期自动删除，因为MAC地址与交换机接口的对应关系不是永久性的**</font>

![交换机自学习例题](img/第三章/交换机自学习例题.png)

#### 交换机生成树协议STP

为提高以太网的可靠性，在路由器之间添加一条冗余链路

![交换机冗余线路](img/第三章/交换机冗余线路.png)

即使A和B之间的链路故障，网络仍然可以通信

但添加冗余链路可能会带来一些问题

![交换机冗余链路问题](img/第三章/交换机冗余链路问题.png)

生成树算法STP可以在增加冗余链路提高网络完整性的同时又能避免网络环路带来的各种问题

- 不论交换机之间如何物理连接，交换机都能够<font color='red'>自动计算并构建一个逻辑上没有环路的网络</font>，其拓补结构必须是树型
- 最终生成的树型拓补要确保<font color='red'>连通整个网络</font>
- 当首次连接交换机或网络物理拓补发生变化时，交换机都会<font color='red'>重新计算生成树</font>

![交换机重新计算生成树](img/第三章/交换机重新计算生成树.png)

### 3.5.3 交换机与集线器区别

![集线器与交换机](img/第三章/集线器与交换机.png)

下图为隔离冲突域的情况

![隔离冲突域](img/第三章/隔离冲突域.png)

![集线器交换机对比](img/第三章/集线器交换机对比.png)

集线器：<font color='red'>**既不能隔离冲突域，又不能隔离广播域**</font>

交换机：<font color='red'>**只能隔离冲突域，不能隔离广播域**</font>

路由器：<font color='red'>**即能隔离冲突域，又能隔离广播域**</font>

## 3.6 VLAN

虚拟局域网VLAN(Virtual Local Area Network)是一种<font color='red'>**将局域网内的设备划分成物理与位置无关的逻辑组**</font>的技术，这些逻辑具有某些共同需求

![VLAN](img/第三章/VLAN.png)
